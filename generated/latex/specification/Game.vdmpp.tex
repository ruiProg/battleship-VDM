\begin{vdmpp}[breaklines=true]
class Game
types
 protected State = <Off> | <Start> | <Placed> | <Round>

instance variables
 protected playerA: Player := new Player("Default_1");
 protected playerB: Player := new Player("Default_2");
 protected currPlayer: Player := playerA;
 protected players: set of Player := {playerA, playerB};
 protected currState: State := <Off>;
 
 inv currPlayer in set {playerA, playerB};
 inv playerA in set players;
 inv playerB in set players;
 inv forall p1, p2 in set players & p1 <> p2 => p1.getName() <> p2.getName();
 
operations
  
  -- cria jogo
(*@
\label{Game:20}
@*)
 public Game: Player`String * Player`String ==> Game
  Game(name1, name2) == (
   playerA := new Player(name1);
   playerB := new Player(name2);
   currPlayer := playerA;
   players := {playerA, playerB};
   return self
  )
  pre currState= <Off> and name1 <> name2
  post card players = 2;
   
(*@
\label{createPlayer:31}
@*)
  -- cria novo jogador com determinado nome se nome ainda não estiver registado
 public createPlayer: (Player`String) ==> Player
  createPlayer(name) == (
   dcl player: Player := new Player(name);
   players := players union {player};
   return player 
  )
  pre not exists p in set players & p.getName() = name;
(*@
\label{changePlayers:39}
@*)
  
  --muda os jogadores que vão realizar jogo 
 public changePlayers: Player`String * Player`String ==> ()
  changePlayers(name1, name2) == (
   dcl tmpPlayer: Player := iota p in set players & p.getName() = name1;
   atomic(playerA := tmpPlayer;
   playerB := iota p in set players & p.getName() = name2;
   currPlayer := tmpPlayer;
   );
  )
(*@
\label{switchTurns:49}
@*)
  pre currState = <Off> and exists p1, p2 in set players & p1.getName() = name1 and p2.getName() = name2;
   
  -- muda o turno para jogar em cada ronda
 public switchTurns: () ==> ()
  switchTurns() == (
   if currPlayer = playerA then currPlayer := playerB
   else currPlayer := playerA
(*@
\label{getOtherPlayer:56}
@*)
  )
  pre currState <> <Off>;
  
  -- retorna o jogador que aguarda o ataque do adversário
 public getOtherPlayer: () ==> Player
  getOtherPlayer() == (
(*@
\label{startGame:62}
@*)
   if currPlayer = playerA then return playerB
   else return playerA;
  );
   
   -- inicia jogo
 public startGame: () ==> Player`String
  startGame() == (
   playerA.addBoards();
   playerB.addBoards();
   currState := <Start>;
   return "Game started with following players:\n"
   ^ playerA.printInfo()
   ^ playerB.printInfo() ^ "\n\n\n\n"
(*@
\label{shipPlacement:75}
@*)
   ^ currPlayer.printPlacementStatus(); 
  )
  pre currState = <Off>;
  
  -- jogador ativo colca os navios no tabuleiro
 public shipPlacement: Board`CellContent * char * nat1 * Board`Direction ==> Player`String
  shipPlacement(ship, colCh, line, dir) == (
   dcl ret: Player`String;
   currPlayer.shipPlacement(ship, colCh, line, dir);
   ret := currPlayer.printPlacementStatus();
   if currPlayer.allShipsPlaced() then(
    switchTurns();
    ret := ret ^ "\n\n\n\n\n";
    if currPlayer.allShipsPlaced() then (
     currState := <Placed>;
     ret := ret ^ "All ships placed\n";
    )
   else ret := ret ^ currPlayer.printPlacementStatus();
(*@
\label{startRounds:93}
@*)
   );
   return ret;
  )
  pre currState = <Start>;
  
  -- inicia rondas no jogo
 public startRounds: () ==> Player`String
  startRounds() == (
   playerA.startRounds();
(*@
\label{guessShipPosition:102}
@*)
   playerB.startRounds();
   currState := <Round>;
   return currPlayer.printGameStatus();
  )
  pre currState = <Placed>;
  
  -- jogador activo tenta adivinhar posição de um navio adversário
 public guessShipPosition: char * nat1 ==> Player`String
  guessShipPosition(colCh, line) == (
   dcl othPlayer: Player := getOtherPlayer();
   dcl code: Board`CellContent := othPlayer.registerAttack(colCh, line);
   dcl ret: Player`String := [];
   dcl final: bool := currPlayer.registerResult(code, colCh, line);
   if code = <Miss> then (
    ret := ret ^ "\n\nSplash!! You missed!\n";
     switchTurns();
    )
   else if code = <Hit> then ret := ret ^ "\n\nGreat strike\n"
   else ret := ret ^ currPlayer.printTakeDown(code);
   if final then(
    ret := ret ^ currPlayer.printVictory();
    currState := <Off>;
    playerA.clearData();
    playerB.clearData();
    return ret;
   );
   ret := ret ^ "\n\n\n\n\n" ^ currPlayer.printGameStatus();
   return ret;
  )
  pre currState = <Round>;
    
end Game
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[Game:20]{Game} & 20&100.0\% & 9 \\
\hline
\hyperref[changePlayers:39]{changePlayers} & 39&100.0\% & 3 \\
\hline
\hyperref[createPlayer:31]{createPlayer} & 31&100.0\% & 3 \\
\hline
\hyperref[getOtherPlayer:56]{getOtherPlayer} & 56&100.0\% & 55 \\
\hline
\hyperref[guessShipPosition:102]{guessShipPosition} & 102&100.0\% & 55 \\
\hline
\hyperref[shipPlacement:75]{shipPlacement} & 75&100.0\% & 60 \\
\hline
\hyperref[startGame:62]{startGame} & 62&100.0\% & 6 \\
\hline
\hyperref[startRounds:93]{startRounds} & 93&100.0\% & 3 \\
\hline
\hyperref[switchTurns:49]{switchTurns} & 49&100.0\% & 23 \\
\hline
\hline
Game.vdmpp & & 100.0\% & 217 \\
\hline
\end{longtable}

