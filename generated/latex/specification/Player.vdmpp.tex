\begin{vdmpp}[breaklines=true]
class Player
types
 public String = seq of char;

instance variables
 protected name: String := [];
 protected wins: nat;
 protected losses: nat;
 protected ownBoard: [Board] := nil; --tabuleiro aonde coloca-se os proprios navios e regista-se as tentativas do inimigo
 protected enemyBoard: [Board] := nil; --tabuleiro das nossas tentativas de destoir a frota inimiga
 protected myShips: set of Board`CellContent := {}; -- navios colocados antes da ronda e meus navios durante as rondas (diminui)
 protected enemiesShips: set of Board`CellContent := {}; -- navios inimigos (aumenta)
 
 inv len name < 256;
 
operations
(*@
\label{Player:17}
@*)
 public Player: String ==> Player
  Player(nameArg) == (
   name := nameArg;
   wins := 0;
   losses := 0;
   return self
  );
   
(*@
\label{getName:25}
@*)
 pure public getName : () ==> String
  getName() == return name;
  
(*@
\label{addBoards:28}
@*)
  -- reinicia jogo 
 public addBoards : () ==> ()
  addBoards() == (
   ownBoard := new Board();
   enemyBoard := new Board();
   myShips := ownBoard.getShips();
  )
  pre ownBoard = nil and enemyBoard = nil;
(*@
\label{shipPlacement:36}
@*)
  
  -- coloca navio no tabuleiro se este ainda não tiver sido colocado
 public shipPlacement: Board`CellContent * char * nat1 * Board`Direction ==> ()
  shipPlacement(ship, colCh, line, dir) == (
   ownBoard.placeShip(ship, colCh, line, dir);
   myShips := myShips \ {ship}
  )
(*@
\label{allShipsPlaced:43}
@*)
  pre ship in set myShips;
 
 -- retorna verdadeiro se todos os navios estão colocados no tabuleiro
(*@
\label{startRounds:46}
@*)
 public allShipsPlaced: () ==> bool
  allShipsPlaced() == return card myShips = 0;
 
 -- inicia parte do jogo com o objetivo de destruir o navio inimigo 
 public startRounds: () ==> ()
  startRounds () == (
(*@
\label{clearData:52}
@*)
   myShips := ownBoard.getShips();
   enemiesShips := {};
  );
 
 -- limpa tabuleiro e registo dos navios
 public clearData: () ==> ()
  clearData() == (
   ownBoard := nil;
(*@
\label{registerAttack:60}
@*)
   enemyBoard := nil;
   myShips := {};
   enemiesShips := {};
  );
 
 -- regista tentativa de afundanço do adversário
 public registerAttack: char * nat1 ==> Board`CellContent
  registerAttack(colCh, line) == (
   dcl shipHit : Board`CellContent := ownBoard.registerMove(colCh, line);
   if ownBoard.countCellType(shipHit) = 0 then (
    myShips := myShips \ {shipHit};
    if card myShips = 0 then losses := losses + 1;
(*@
\label{registerResult:72}
@*)
    return shipHit;
   )
   else if shipHit <> <Empty> then return <Hit>
   else return <Miss>;
  );
 
 -- regista a sua tentativa de afundar um navio adversário
 public registerResult: Board`CellContent * char * nat1 ==> bool
  registerResult(code,colCh, line) == (
  if code = <Miss> then enemyBoard.setComponentCol(<Miss>,line,colCh)
  else(
   enemyBoard.setComponentCol(<Hit>,line,colCh);
    if code <> <Hit> then enemiesShips := enemiesShips union {code};
    if card enemiesShips = enemyBoard.getShipsCount() then(
     wins := wins + 1;
     return true;
(*@
\label{printInfo:88}
@*)
    );
   );
   return false;
 );
 
(*@
\label{printPlacementStatus:93}
@*)
--- print to console
 
 public printInfo : () ==> String
  printInfo() == return name ^ " (" ^ 
   VDMUtil`val2seq_of_char[nat](wins) ^ "-" ^ 
(*@
\label{printGameStatus:98}
@*)
   VDMUtil`val2seq_of_char[nat](losses) ^ ")\n";
 
 public printPlacementStatus: () ==> String
  printPlacementStatus() == return "Fleet placement\nPlayer turn: " ^ name ^ "\n" ^
  "Ships to be placed: " ^ ownBoard.printRemainShips(myShips) ^ "\n\n" ^
  ownBoard.printBoard();
  
 public printGameStatus : () ==> String
  printGameStatus() == (
   dcl ret: String := "Player turn: " ^ name ^ "\nMy active ships: ";
   for all ship in set myShips do ret := ret ^ ownBoard.shipToString(ship) ^ "   ";
(*@
\label{printTakeDown:109}
@*)
   ret := ret ^ "\nDestroyed enemies ships: ";
   for all ship in set enemiesShips do ret := ret ^ enemyBoard.shipToString(ship) ^ "   ";
   ret := ret ^ "\n\n                                 My ships \t\t\t\t\t\t\t\t\t                Enemy ships\n\n\n";
(*@
\label{printVictory:112}
@*)
   ret := ret ^ ownBoard.printParallelBoards(enemyBoard);
   return ret;
  );
   
 public printTakeDown : Board`CellContent ==> String
  printTakeDown(shipDown) == return "\n\n" ^ enemyBoard.shipToString(shipDown) ^ " is sinking\n";
  
 public printVictory : () ==> String
  printVictory() == return "\nEnemy fleet destroyed. Victory!\n";

end Player
\end{vdmpp}
\bigskip
\begin{longtable}{|l|r|r|r|}
\hline
Function or operation & Line & Coverage & Calls \\
\hline
\hline
\hyperref[Player:17]{Player} & 17&100.0\% & 12 \\
\hline
\hyperref[addBoards:28]{addBoards} & 28&100.0\% & 12 \\
\hline
\hyperref[allShipsPlaced:43]{allShipsPlaced} & 43&100.0\% & 6 \\
\hline
\hyperref[clearData:52]{clearData} & 52&100.0\% & 3 \\
\hline
\hyperref[getName:25]{getName} & 25&100.0\% & 3 \\
\hline
\hyperref[printGameStatus:98]{printGameStatus} & 98&0.0\% & 0 \\
\hline
\hyperref[printInfo:88]{printInfo} & 88&0.0\% & 0 \\
\hline
\hyperref[printPlacementStatus:93]{printPlacementStatus} & 93&0.0\% & 0 \\
\hline
\hyperref[printTakeDown:109]{printTakeDown} & 109&0.0\% & 0 \\
\hline
\hyperref[printVictory:112]{printVictory} & 112&0.0\% & 0 \\
\hline
\hyperref[registerAttack:60]{registerAttack} & 60&100.0\% & 57 \\
\hline
\hyperref[registerResult:72]{registerResult} & 72&100.0\% & 17 \\
\hline
\hyperref[shipPlacement:36]{shipPlacement} & 36&100.0\% & 30 \\
\hline
\hyperref[startRounds:46]{startRounds} & 46&100.0\% & 6 \\
\hline
\hline
Player.vdmpp & & 63.5\% & 146 \\
\hline
\end{longtable}

